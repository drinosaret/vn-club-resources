name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@2ead5e36573f08b82fbfce1504f1a4b05a647c6f # v1.2.2
        env:
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          DISCORD_ADMIN_USER_IDS: ${{ secrets.DISCORD_ADMIN_USER_IDS }}
          DISCORD_LOG_WEBHOOK_URL: ${{ secrets.DISCORD_LOG_WEBHOOK_URL }}
          TWITTER_AUTH_TOKEN: ${{ secrets.TWITTER_AUTH_TOKEN }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: deploy
          key: ${{ secrets.VPS_SSH_KEY }}
          envs: DISCORD_BOT_TOKEN,DISCORD_ADMIN_USER_IDS,DISCORD_LOG_WEBHOOK_URL,TWITTER_AUTH_TOKEN
          script: |
            cd ~/vn-club-resources
            git pull --ff-only

            # Sync GitHub secrets into .env.prod (add or update each key)
            ENV_FILE=deploy/.env.prod
            update_env() {
              local key="$1" val="$2"
              [ -z "$val" ] && return
              if grep -q "^${key}=" "$ENV_FILE" 2>/dev/null; then
                sed -i "s|^${key}=.*|${key}=${val}|" "$ENV_FILE"
              else
                echo "${key}=${val}" >> "$ENV_FILE"
              fi
            }
            update_env DISCORD_BOT_TOKEN "$DISCORD_BOT_TOKEN"
            update_env DISCORD_ADMIN_USER_IDS "$DISCORD_ADMIN_USER_IDS"
            update_env DISCORD_LOG_WEBHOOK_URL "$DISCORD_LOG_WEBHOOK_URL"
            update_env TWITTER_AUTH_TOKEN "$TWITTER_AUTH_TOKEN"

            # Generate git dates for guide pages (Docker has no .git)
            node scripts/generate-git-dates.js

            docker compose -f docker-compose.prod.yml --env-file deploy/.env.prod up -d --build
            # Recreate nginx â€” git pull creates new file inodes, but Docker bind mounts
            # track the old inode. `nginx -s reload` reads the stale mount. Recreating
            # the container rebinds to the current inode. --no-deps prevents cascading.
            docker compose -f docker-compose.prod.yml --env-file deploy/.env.prod up -d --force-recreate --no-deps nginx
            docker image prune -f
