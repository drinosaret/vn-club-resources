worker_processes auto;

events {
    worker_connections 1024;
}

http {
    # ---------- Basics ----------
    server_tokens   off;
    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 10M;

    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # ---------- Logging ----------
    log_format main '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent"';
    access_log /var/log/nginx/access.log main;
    error_log  /var/log/nginx/error.log warn;

    # ---------- Gzip ----------
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 5;
    gzip_types
        text/plain
        text/css
        application/json
        application/javascript
        text/xml
        application/xml
        text/javascript
        image/svg+xml;

    # ---------- Rate limiting ----------
    limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=api:10m rate=30r/s;

    # ---------- Cloudflare real IP ----------
    # IPv4 — https://www.cloudflare.com/ips-v4/
    set_real_ip_from 173.245.48.0/20;
    set_real_ip_from 103.21.244.0/22;
    set_real_ip_from 103.22.200.0/22;
    set_real_ip_from 103.31.4.0/22;
    set_real_ip_from 141.101.64.0/18;
    set_real_ip_from 108.162.192.0/18;
    set_real_ip_from 190.93.240.0/20;
    set_real_ip_from 188.114.96.0/20;
    set_real_ip_from 197.234.240.0/22;
    set_real_ip_from 198.41.128.0/17;
    set_real_ip_from 162.158.0.0/15;
    set_real_ip_from 104.16.0.0/13;
    set_real_ip_from 104.24.0.0/14;
    set_real_ip_from 172.64.0.0/13;
    set_real_ip_from 131.0.72.0/22;
    # IPv6 — https://www.cloudflare.com/ips-v6/
    set_real_ip_from 2400:cb00::/32;
    set_real_ip_from 2606:4700::/32;
    set_real_ip_from 2803:f800::/32;
    set_real_ip_from 2405:b500::/32;
    set_real_ip_from 2405:8100::/32;
    set_real_ip_from 2a06:98c0::/29;
    set_real_ip_from 2c0f:f248::/32;
    real_ip_header CF-Connecting-IP;

    # ---------- Upstreams ----------
    upstream frontend {
        server web:3000;
    }

    upstream backend {
        server api:8000;
    }

    # ---------- SSL (Cloudflare Origin CA) ----------
    # To enable HTTPS on the origin:
    # 1. Generate an Origin CA cert in Cloudflare dashboard
    # 2. Save cert to deploy/nginx/ssl/origin.pem
    # 3. Save key to deploy/nginx/ssl/origin.key
    # 4. Mount the ssl directory in docker-compose.prod.yml
    # 5. Set Cloudflare SSL/TLS mode to "Full (strict)"
    #
    # Until certs are installed, nginx listens on port 80 only.
    # Cloudflare terminates TLS on the edge; traffic between
    # Cloudflare and origin is over HTTP unless Origin CA is configured.

    # ---------- vnclub.org — Frontend ----------
    server {
        listen 80;
        listen 443 ssl;
        server_name vnclub.org www.vnclub.org beta.vnclub.org;

        # SSL certs — only loaded if files exist (nginx skips missing includes)
        ssl_certificate     /etc/nginx/ssl/origin.pem;
        ssl_certificate_key /etc/nginx/ssl/origin.key;
        ssl_protocols       TLSv1.2 TLSv1.3;
        ssl_ciphers         HIGH:!aNULL:!MD5;

        # Security headers (defense-in-depth, supplements what Next.js sets)
        add_header X-Robots-Tag "index, follow" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

        # Block source map access
        location ~ \.map$ {
            return 404;
        }

        location / {
            limit_req zone=general burst=30 nodelay;

            proxy_pass http://frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            proxy_cache_bypass $http_upgrade;
        }
    }

    # ---------- api.vnclub.org — Backend API ----------
    server {
        listen 80;
        listen 443 ssl;
        server_name api.vnclub.org;

        ssl_certificate     /etc/nginx/ssl/origin.pem;
        ssl_certificate_key /etc/nginx/ssl/origin.key;
        ssl_protocols       TLSv1.2 TLSv1.3;
        ssl_ciphers         HIGH:!aNULL:!MD5;

        location / {
            limit_req zone=api burst=50 nodelay;

            proxy_pass http://backend;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;

            # SSE support (streaming endpoints)
            proxy_set_header Connection '';
            proxy_buffering off;
            proxy_read_timeout 3600s;
        }

        # Health check — bypass rate limit
        location = /health {
            proxy_pass http://backend;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
        }
    }

    # ---------- Catch-all — reject direct IP access ----------
    server {
        listen 80 default_server;
        listen 443 default_server ssl;
        server_name _;

        ssl_certificate     /etc/nginx/ssl/origin.pem;
        ssl_certificate_key /etc/nginx/ssl/origin.key;

        return 444;
    }
}
