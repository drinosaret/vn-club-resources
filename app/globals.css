@import 'tailwindcss';

@custom-variant dark (&:is(.dark *));

@theme {
  --font-jp: 'Hiragino Kaku Gothic Pro', 'Hiragino Sans', Meiryo, sans-serif;

  --color-background: var(--background);
  --color-foreground: var(--foreground);

  --color-primary-50: #eef2ff;
  --color-primary-100: #e0e7ff;
  --color-primary-200: #c7d2fe;
  --color-primary-300: #a5b4fc;
  --color-primary-400: #818cf8;
  --color-primary-500: #6366f1;
  --color-primary-600: #4f46e5;
  --color-primary-700: #4338ca;
  --color-primary-800: #3730a3;
  --color-primary-900: #312e81;
}

/*
  The default border color has changed to `currentcolor` in Tailwind CSS v4,
  so we've added these compatibility styles to make sure everything still
  looks the same as it did with Tailwind CSS v3.

  If we ever want to remove these styles, we need to add an explicit border
  color utility to any element that depends on these defaults.
*/
@layer base {
  *,
  ::after,
  ::before,
  ::backdrop,
  ::file-selector-button {
    border-color: var(--color-gray-200, currentcolor);
  }

  /* Restore cursor: pointer on interactive elements (Tailwind v4 follows CSS spec default) */
  button:not(:disabled),
  [role="button"]:not(:disabled),
  a,
  select,
  summary {
    cursor: pointer;
  }
}

@utility text-balance {
  text-wrap: balance;
}

/* Prevent layout shift when scrollbar appears/disappears */
html {
  scrollbar-gutter: stable;
}

/* Font-Flash Fix */

/* Fix 1 — make transition-all safe by excluding font/text-layout properties.
   Unlayered so it beats Tailwind's version of .transition-all. */
.transition-all {
  transition-property:
    color,
    background-color,
    border-color,
    text-decoration-color,
    fill,
    stroke,
    opacity,
    box-shadow,
    transform,
    filter,
    -webkit-backdrop-filter,
    backdrop-filter,
    width,
    height,
    max-width,
    max-height,
    min-width,
    min-height,
    padding,
    margin,
    gap,
    inset,
    top,
    right,
    bottom,
    left,
    border-radius,
    outline-color,
    outline-offset,
    flex,
    flex-grow,
    flex-shrink,
    flex-basis,
    grid-template-columns,
    grid-template-rows,
    column-gap,
    row-gap,
    visibility,
    z-index,
    order,
    translate,
    rotate,
    scale;
}

/* Fix 2 — kill all transitions during initial load (class removed after hydration) */
html.no-transitions,
html.no-transitions *,
html.no-transitions *::before,
html.no-transitions *::after {
  transition-duration: 0s !important;
  transition-delay: 0s !important;
}

@keyframes slide-down {
  from {
    opacity: 0;
    transform: translateY(-8px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-slide-down {
  animation: slide-down 150ms ease-out;
}

:root {
  --background: #ffffff;
  --foreground: #171717;

  /* Design System Tokens (see .interface-design/system.md) */
  /* Text hierarchy */
  --text-primary: #111827; /* gray-900 */
  --text-secondary: #4b5563; /* gray-600 */
  --text-muted: #6b7280; /* gray-500 */
  --text-faint: #9ca3af; /* gray-400 */

  /* Surfaces */
  --surface-base: #ffffff;
  --surface-raised: #ffffff;
  --surface-overlay: #ffffff;
  --surface-inset: #f9fafb; /* gray-50 */

  /* Borders */
  --border-default: #e5e7eb; /* gray-200 */
  --border-subtle: #f3f4f6; /* gray-100 */
  --border-strong: #d1d5db; /* gray-300 */

  /* Brand */
  --brand-primary: #4f46e5; /* indigo-600 */
  --brand-primary-hover: #4338ca; /* indigo-700 */
}

.dark {
  --background: #0a0a0a;
  --foreground: #ededed;

  /* Design System Tokens (dark mode) */
  --text-primary: #ffffff;
  --text-secondary: #9ca3af; /* gray-400 */
  --text-muted: #9ca3af; /* gray-400 */
  --text-faint: #6b7280; /* gray-500 */

  --surface-base: #111827; /* gray-900 */
  --surface-raised: #1f2937; /* gray-800 */
  --surface-overlay: #1f2937; /* gray-800 */
  --surface-inset: #1f2937; /* gray-800 */

  --border-default: #374151; /* gray-700 */
  --border-subtle: rgba(75, 85, 99, 0.5); /* gray-600/50 */
  --border-strong: #4b5563; /* gray-600 */

  --brand-primary: #818cf8; /* indigo-400 */
  --brand-primary-hover: #a5b4fc; /* indigo-300 */
}

html,
body {
  color: var(--foreground);
  background: var(--background);
}

/* Firefox-only rendering debug profiles.
  Controlled via Settings menu (session-scoped flags in sessionStorage). */
@supports (-moz-appearance: none) {
  html.ffdbg-motion *,
  html.ffdbg-motion *::before,
  html.ffdbg-motion *::after {
    animation: none !important;
    transition: none !important;
  }

  html.ffdbg-filters *,
  html.ffdbg-filters *::before,
  html.ffdbg-filters *::after {
    filter: none !important;
    backdrop-filter: none !important;
  }

  html.ffdbg-contain-main main,
  html.ffdbg-contain-grid .browse-vn-grid,
  html.ffdbg-contain-grid .browse-vn-grid-content {
    contain: none !important;
  }

  html.ffdbg-cover-hover .browse-vn-card,
  html.ffdbg-cover-hover .browse-vn-card:hover {
    transform: none !important;
    box-shadow: none !important;
  }

  html.ffdbg-grid-fade .browse-vn-grid-content,
  html.ffdbg-grid-fade .browse-vn-title,
  html.ffdbg-grid-fade .browse-tab-button,
  html.ffdbg-grid-fade .title-language-label {
    transition: none !important;
    opacity: 1 !important;
  }

  html.ffdbg-text .browse-vn-title,
  html.ffdbg-text .browse-tab-button,
  html.ffdbg-text .title-language-label {
    text-rendering: optimizeLegibility;
    -moz-osx-font-smoothing: grayscale;
  }

  /* Disable scroll-restoration opacity hide — tests if stt-restoring causes blink */
  html.ffdbg-nostt.stt-restoring main {
    opacity: 1 !important;
  }

  /* Paint diagnostic — red tint on blinking elements.
     If background disappears too → DOM/React issue.
     If only text disappears → Firefox WebRender async raster. */
  html.ffdbg-paint .browse-vn-title,
  html.ffdbg-paint .browse-tab-button,
  html.ffdbg-paint .title-language-label {
    background: rgba(255, 0, 0, 0.15) !important;
  }

  /* Remove line-clamp from VN titles — tests webkit-line-clamp paint quirks */
  html.ffdbg-noclamp .browse-vn-title {
    -webkit-line-clamp: unset !important;
    display: block !important;
    -webkit-box-orient: unset !important;
  }

  /* Force system font stack — tests webfont rendering/loading issues */
  html.ffdbg-sysfont body,
  html.ffdbg-sysfont .browse-vn-title,
  html.ffdbg-sysfont .browse-tab-button,
  html.ffdbg-sysfont .title-language-label {
    font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
  }

  /* Force text into its own composited layer — tests WebRender text raster path */
  html.ffdbg-textlayer .browse-vn-title,
  html.ffdbg-textlayer .browse-tab-button,
  html.ffdbg-textlayer .title-language-label {
    transform: translateZ(0) !important;
    backface-visibility: hidden !important;
    will-change: transform !important;
  }

  /* Disable clipping/overflow constraints around cards — tests clip invalidation issues */
  html.ffdbg-noclip .browse-vn-card {
    overflow: visible !important;
    contain: none !important;
  }

  /* Promote major containers to GPU layers — tests if broader layer promotion
     prevents text blink even with web fonts (Roboto) */
  html.ffdbg-gpulayer main,
  html.ffdbg-gpulayer .browse-vn-grid-content,
  html.ffdbg-gpulayer .browse-vn-title,
  html.ffdbg-gpulayer .browse-tab-button,
  html.ffdbg-gpulayer .title-language-label {
    transform: translateZ(0) !important;
    backface-visibility: hidden !important;
    will-change: transform !important;
  }
}

/* ═══ Firefox Text Blink Fix ═══
   Firefox WebRender rasterizes web font glyphs asynchronously, causing text to
   briefly disappear (1-2 frames). System fonts use pre-cached OS glyphs.

   Fix: metric-adjusted system fonts in Firefox so text occupies the same space
   as Roboto, plus GPU layer promotion on affected elements. The @font-face
   uses size-adjust and *-override to match Segoe UI to Roboto's metrics.

   Weight coverage: Roboto loads 400/500/700. Each needs its own @font-face so
   Firefox uses real weight variants (not faux-bold synthesis) and applies the
   metric overrides at every weight. On Win 11, Segoe UI Variable (a variable
   font) handles all weights natively. On Win 10, Segoe UI Semibold/Bold are
   separate font files. macOS falls through to system-ui (SF Pro). */
@supports (-moz-appearance: none) {
  /* Regular (400) — body text, descriptions */
  @font-face {
    font-family: 'RobotoSystemFallback';
    src: local('Segoe UI Variable'), local('Segoe UI'), local('system-ui');
    font-weight: 400;
    font-style: normal;
    size-adjust: 100%;
    ascent-override: 92.8%;
    descent-override: 24.4%;
    line-gap-override: 0%;
  }

  /* Medium (500) — button labels, nav links, filter chips, table headers */
  @font-face {
    font-family: 'RobotoSystemFallback';
    src: local('Segoe UI Variable'), local('Segoe UI'), local('system-ui');
    font-weight: 500;
    font-style: normal;
    size-adjust: 100%;
    ascent-override: 92.8%;
    descent-override: 24.4%;
    line-gap-override: 0%;
  }

  /* Semibold (600) — card titles, section headers, admonition titles */
  @font-face {
    font-family: 'RobotoSystemFallback';
    src: local('Segoe UI Variable'), local('Segoe UI Semibold'), local('Segoe UI'), local('system-ui');
    font-weight: 600;
    font-style: normal;
    size-adjust: 100%;
    ascent-override: 92.8%;
    descent-override: 24.4%;
    line-gap-override: 0%;
  }

  /* Bold (700) — page headings, hero text, site logo */
  @font-face {
    font-family: 'RobotoSystemFallback';
    src: local('Segoe UI Variable'), local('Segoe UI Bold'), local('Segoe UI'), local('system-ui');
    font-weight: 700;
    font-style: normal;
    size-adjust: 100%;
    ascent-override: 92.8%;
    descent-override: 24.4%;
    line-gap-override: 0%;
  }

  /* Extra-bold (800) — used by weight compensation rules below */
  @font-face {
    font-family: 'RobotoSystemFallback';
    src: local('Segoe UI Variable'), local('Segoe UI Bold'), local('Segoe UI'), local('system-ui');
    font-weight: 800;
    font-style: normal;
    size-adjust: 100%;
    ascent-override: 92.8%;
    descent-override: 24.4%;
    line-gap-override: 0%;
  }

  body {
    font-family: 'RobotoSystemFallback', system-ui, -apple-system, sans-serif !important;
    letter-spacing: -0.011em;
    font-variation-settings: 'wght' 430;
    text-rendering: optimizeLegibility;
  }

  h1, h2, h3, h4, h5, h6 {
    letter-spacing: -0.02em;
  }

  /* Weight compensation: Segoe UI has lighter stroke weight than Roboto at the
     same nominal value, reducing visual contrast between body and bold text.
     Bump bold contexts up ~100 to restore the hierarchy Roboto provides.
     On Win 11 (variable font), 800 clamps to 700 (axis max).
     On Win 10 (static faces), 800 synthesizes slightly from Bold (700). */
  h1, h2 {
    font-weight: 800 !important;
  }

  h3, h4, h5, h6 {
    font-weight: 700 !important;
  }

  strong, b {
    font-weight: 800 !important;
  }

  /* Tailwind weight class compensation: Segoe UI appears ~100 weight units
     lighter than Roboto at the same nominal value. Bump each tier up one step
     to match the visual hierarchy Chrome/Roboto provides. */
  .font-medium {
    font-weight: 600 !important;
  }

  .font-semibold {
    font-weight: 700 !important;
  }

  .font-bold {
    font-weight: 800 !important;
  }

  .font-black {
    font-weight: 900 !important;
  }

  /* Opt-out: don't over-compensate tiny text */
  .text-xs.font-medium {
    font-weight: 500 !important;
  }

  .browse-vn-title,
  .browse-tab-button,
  .title-language-label {
    transform: translateZ(0) !important;
    backface-visibility: hidden !important;
    will-change: transform !important;
  }
}

/* Smooth scroll only for in-page anchor navigation (not page changes) */
/* Applied via scroll-smooth class on specific elements or via JS */

body {
  overscroll-behavior-y: contain; /* Prevent pull-to-refresh and scroll chaining on mobile */
}

/* ═══ View Transition Defensive Rules ═══
   The bundled react-dom includes startViewTransition() support (activated only
   when <ViewTransition> components are in the tree — not currently used).
   These rules are kept as defensive CSS: if VTs are ever enabled, they prevent
   Firefox WebRender's async text rasterization from causing visible flashes
   during the VT snapshot/swap lifecycle. */
::view-transition-old(root),
::view-transition-new(root) {
  animation: none;
  mix-blend-mode: normal;
}
main {
  view-transition-name: none;
}
::view-transition-group(*) {
  animation-duration: 0s;
}

/* ═══ Below-Fold Paint Optimization ═══
   content-visibility: auto defers paint for off-screen VN cards.
   With 42 items per page (small grid), only ~12 are above the fold —
   the remaining ~30 skip layout/paint until scrolled into view. */
.browse-vn-grid-content > a {
  content-visibility: auto;
  contain-intrinsic-size: auto 180px 300px;
}

/* Custom styles for markdown content */
.prose {
  @apply max-w-none;
  color: #1f2937 !important;
}

.dark .prose {
  color: #e5e7eb !important;
}

/* Scroll margin for all headings with IDs (for anchor link navigation) */
h1[id], h2[id], h3[id], h4[id], h5[id], h6[id] {
  scroll-margin-top: 5rem;
}

.prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 {
  scroll-margin-top: 5rem;
}

.prose h1 {
  @apply text-4xl font-bold mt-8 mb-4;
  color: #111827 !important;
}

.dark .prose h1 {
  color: #f9fafb !important;
}

.prose h2 {
  @apply text-3xl font-bold mt-6 mb-3;
  color: #111827 !important;
}

.dark .prose h2 {
  color: #f9fafb !important;
}

.prose h3 {
  @apply text-2xl font-semibold mt-5 mb-2;
  color: #111827 !important;
}

.dark .prose h3 {
  color: #f9fafb !important;
}

.prose p {
  @apply mb-4 leading-relaxed;
  color: #374151 !important;
}

.dark .prose p {
  color: #d1d5db !important;
}

.prose a {
  @apply underline;
  color: #4f46e5 !important;
}

.prose a:hover {
  color: #4338ca !important;
}

.dark .prose a {
  color: #818cf8 !important;
}

.dark .prose a:hover {
  color: #a5b4fc !important;
}

.prose ul, .prose ol {
  @apply my-4 ml-6;
}

.prose li {
  @apply mb-2;
  color: #374151 !important;
}

.dark .prose li {
  color: #d1d5db !important;
}

.prose code {
  @apply bg-gray-100 px-1.5 py-0.5 rounded-sm text-sm font-mono;
  color: #db2777 !important;
}

.dark .prose code {
  @apply bg-gray-800;
  color: #f472b6 !important;
}

.prose pre {
  @apply bg-gray-100 p-4 rounded-lg overflow-x-auto my-4;
}

.dark .prose pre {
  @apply bg-gray-800;
}

.prose blockquote {
  @apply border-l-4 border-primary-500 pl-4 italic my-4;
  color: #374151 !important;
}

.dark .prose blockquote {
  color: #d1d5db !important;
}

.prose img {
  @apply rounded-lg my-4 mx-auto;
  max-width: 700px;
  width: 100%;
  height: auto;
}


/* Side-by-side images container */
.image-row {
  display: flex;
  gap: 1rem;
  justify-content: center;
  flex-wrap: wrap;
  margin: 1rem 0;
}

.image-row img {
  max-width: 280px;
  width: auto;
  margin: 0;
}

.prose strong {
  color: #111827 !important;
  font-weight: 600;
}

.dark .prose strong {
  color: #f9fafb !important;
}

/* Custom scrollbar for sidebar navigation */
.sidebar-scroll {
  scrollbar-width: thin;
  scrollbar-color: #d1d5db transparent;
}

.dark .sidebar-scroll {
  scrollbar-color: #4b5563 transparent;
}

/* Webkit browsers (Chrome, Safari, Edge) */
.sidebar-scroll::-webkit-scrollbar {
  width: 6px;
}

.sidebar-scroll::-webkit-scrollbar-track {
  background: transparent;
}

.sidebar-scroll::-webkit-scrollbar-thumb {
  background-color: #d1d5db;
  border-radius: 3px;
}

.sidebar-scroll::-webkit-scrollbar-thumb:hover {
  background-color: #9ca3af;
}

.dark .sidebar-scroll::-webkit-scrollbar-thumb {
  background-color: #4b5563;
}

.dark .sidebar-scroll::-webkit-scrollbar-thumb:hover {
  background-color: #6b7280;
}

/* Thin scrollbar for horizontal overflow areas */
.scrollbar-thin {
  scrollbar-width: thin;
  scrollbar-color: #d1d5db transparent;
}

.dark .scrollbar-thin {
  scrollbar-color: #4b5563 transparent;
}

.scrollbar-thin::-webkit-scrollbar {
  height: 6px;
}

.scrollbar-thin::-webkit-scrollbar-track {
  background: transparent;
}

.scrollbar-thin::-webkit-scrollbar-thumb {
  background-color: #d1d5db;
  border-radius: 3px;
}

.scrollbar-thin::-webkit-scrollbar-thumb:hover {
  background-color: #9ca3af;
}

.dark .scrollbar-thin::-webkit-scrollbar-thumb {
  background-color: #4b5563;
}

.dark .scrollbar-thin::-webkit-scrollbar-thumb:hover {
  background-color: #6b7280;
}

/* Hide scrollbar completely */
.scrollbar-none {
  scrollbar-width: none;
  -ms-overflow-style: none;
}

.scrollbar-none::-webkit-scrollbar {
  display: none;
}

/* Scrollbar visible only on hover */
.scrollbar-hover {
  scrollbar-width: thin;
  scrollbar-color: transparent transparent;
}

.scrollbar-hover:hover {
  scrollbar-color: #d1d5db transparent;
}

.dark .scrollbar-hover:hover {
  scrollbar-color: #4b5563 transparent;
}

.scrollbar-hover::-webkit-scrollbar {
  width: 4px;
}

.scrollbar-hover::-webkit-scrollbar-track {
  background: transparent;
}

.scrollbar-hover::-webkit-scrollbar-thumb {
  background-color: transparent;
  border-radius: 2px;
  transition: background-color 0.2s;
}

.scrollbar-hover:hover::-webkit-scrollbar-thumb {
  background-color: #d1d5db;
}

.dark .scrollbar-hover:hover::-webkit-scrollbar-thumb {
  background-color: #4b5563;
}

/* Fade-in animation for tab content */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(4px); }
  to { opacity: 1; transform: translateY(0); }
}

.animate-fade-in {
  animation: fadeIn 200ms ease-out backwards;
}

/* Shimmer animation for skeleton loading */
@keyframes shimmer {
  0% {
    transform: translateX(-100%);
  }
  100% {
    transform: translateX(100%);
  }
}

.animate-shimmer {
  animation: shimmer 1.5s infinite;
}

/* Floating animation for hero VN covers */
@keyframes float {
  0%, 100% {
    transform: translate(-50%, -50%) translateY(0) rotate(0deg);
  }
  25% {
    transform: translate(-50%, -50%) translateY(-15px) rotate(1deg);
  }
  50% {
    transform: translate(-50%, -50%) translateY(-25px) rotate(-1deg);
  }
  75% {
    transform: translate(-50%, -50%) translateY(-10px) rotate(0.5deg);
  }
}

/* Respect reduced motion preferences */
@media (prefers-reduced-motion: reduce) {
  @keyframes float {
    0%, 100% {
      transform: translate(-50%, -50%);
    }
  }

  @keyframes shimmer {
    0%, 100% {
      transform: translateX(0);
    }
  }

  .animate-shimmer,
  .image-placeholder {
    animation: none;
  }

  .vn-tabpanel-active,
  .vn-tabpanel-hidden {
    transition: none;
  }
}

/* Subtle pulse animation for loading placeholders.
   Animates background-color (not opacity) to avoid creating compositor layers
   in Firefox — opacity animations create a GPU layer per element, and 42 cover
   placeholders on the browse page exceed the will-change memory budget. */
@keyframes placeholder-pulse {
  0%, 100% { background-color: rgb(229 231 235); }
  50% { background-color: rgb(209 213 219); }
}

@keyframes placeholder-pulse-dark {
  0%, 100% { background-color: rgb(55 65 81); }
  50% { background-color: rgb(65 75 91); }
}

.image-placeholder {
  background-color: rgb(229 231 235);
  animation: placeholder-pulse 1.8s ease-in-out infinite;
}

.dark .image-placeholder {
  background-color: rgb(55 65 81);
  animation-name: placeholder-pulse-dark;
}

/* NProgress loading bar */
#nprogress {
  pointer-events: none;
}

#nprogress .bar {
  background: #6366f1;
  position: fixed;
  z-index: 9999;
  top: 0;
  left: 0;
  width: 100%;
  height: 3px;
}

.dark #nprogress .bar {
  background: #818cf8;
}

#nprogress .peg {
  display: block;
  position: absolute;
  right: 0px;
  width: 100px;
  height: 100%;
  box-shadow: 0 0 10px #6366f1, 0 0 5px #6366f1;
  opacity: 1;
  transform: rotate(3deg) translate(0px, -4px);
}

.dark #nprogress .peg {
  box-shadow: 0 0 10px #818cf8, 0 0 5px #818cf8;
}

/* loading-overlay intentionally has NO will-change — the overlay covers the
   entire VN grid (potentially 1200×3000+ px) and would exceed Firefox's
   will-change memory budget even as a single element. The opacity transition
   works fine without it. */

/* Indeterminate progress bar for pagination */
@keyframes progress-indeterminate {
  0% { transform: translateX(-100%); width: 40%; }
  50% { transform: translateX(60%); width: 60%; }
  100% { transform: translateX(200%); width: 40%; }
}

.animate-progress-indeterminate {
  animation: progress-indeterminate 1.5s ease-in-out infinite;
}

/* Hide main content during scroll restoration to prevent position-0 flash.
   Applied by ScrollToTop via useLayoutEffect (before paint), removed after scroll. */
html.stt-restoring main {
  opacity: 0 !important;
  transition: none !important;
}

/* Force-unblur NSFW images when parent lightbox has revealed them */
[data-nsfw-revealed="true"] .blur-lg {
  filter: none !important;
}

/* ═══ VN Detail Page: Tab Panel Visibility ═══
   Opacity/position layering instead of display:none.
   Avoids Firefox WebRender text re-rasterization on tab switch. */
.vn-tabpanel-active {
  position: relative;
  opacity: 1;
  visibility: visible;
  pointer-events: auto;
}

.vn-tabpanel-hidden {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
  height: 0;           /* Collapse so content doesn't extend scroll area on mobile */
  overflow: hidden;    /* Clip content within collapsed bounds */
}

/* Tab scroll fade edges on mobile */
.vn-tabs-scroll {
  -webkit-overflow-scrolling: touch;
  mask-image: linear-gradient(to right, transparent, black 8px, black calc(100% - 8px), transparent);
  -webkit-mask-image: linear-gradient(to right, transparent, black 8px, black calc(100% - 8px), transparent);
}

/* Only apply fade mask when scrollable */
@media (min-width: 640px) {
  .vn-tabs-scroll {
    mask-image: none;
    -webkit-mask-image: none;
  }
}
